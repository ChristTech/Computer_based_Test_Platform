{% extends "base.html" %}
{% block title %}Login · CBT{% endblock %}
{% block content %}
<style>
:root {
  --accent: #0b5fff;
  --accent-light: #dbeefe;
  --bg: #f7fbff;
  --card-bg: #fff;
  --muted: #6b7280;
  --shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
  --radius: 12px;
}
body {
  font-family: "Inter", system-ui, Arial;
  background: var(--bg);
  margin: 0;
  color: #0b2540;
}

.container {
  max-width: 860px;
  margin: 40px auto;
  padding: 16px;
}

.card {
  background: var(--card-bg);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 28px 32px;
  transition: all 0.3s ease;
}
.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 28px rgba(2, 6, 23, 0.08);
}

h2 {
  color: var(--accent);
  margin-bottom: 8px;
}
.small {
  color: var(--muted);
  font-size: 13px;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 10px;
  margin: 20px 0;
}
.tab {
  flex: 1;
  padding: 10px 14px;
  text-align: center;
  border-radius: 8px;
  background: var(--accent-light);
  color: var(--accent);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}
.tab:hover {
  background: #cbe2ff;
}
.tab.active {
  background: var(--accent);
  color: #fff;
  box-shadow: 0 4px 10px rgba(11, 95, 255, 0.25);
}

/* Form Groups */
.group {
  display: none;
  animation: fadeIn 0.35s ease forwards;
}
.group.active {
  display: block;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Inputs and Selects */
input, select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #dbeefe;
  font-size: 15px;
  transition: all 0.2s;
  background: #fbfdff;
  color: #0b2540;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
}
input:focus, select:focus {
  border-color: var(--accent);
  outline: none;
  box-shadow: 0 0 0 3px rgba(11,95,255,0.15);
}

/* Animated select styling */
select {
  appearance: none;
  background: url("data:image/svg+xml;utf8,<svg fill='%230b5fff' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M7 10l5 5 5-5H7z'/></svg>")
    no-repeat right 12px center/14px auto, #fbfdff;
}
select:hover {
  background-color: #f1f6ff;
}

/* Buttons */
button {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 15px;
  cursor: pointer;
  transition: background 0.25s, transform 0.1s;
}
button:hover {
  background: #0056b3;
  transform: translateY(-1px);
}
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
button.alt {
  background: #fff;
  color: var(--accent);
  border: 1px solid var(--accent-light);
}

/* Layout */
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}
@media(max-width:800px){
  .grid { grid-template-columns: 1fr; }
}
label {
  font-weight: 500;
  font-size: 14px;
  display: block;
  margin-bottom: 4px;
  color: #0b2540;
}

/* Subtle floating animation for form elements */
select, input {
  transition: all 0.25s ease;
}
select:focus, input:focus {
  transform: scale(1.02);
}

/* Message texts */
#loginMsg, #teacherMsg, #adminMsg, #teacherRegMsg {
  font-size: 13px;
  margin-top: 8px;
  color: var(--muted);
}

/* Searchable student dropdown */
.searchable-select {
  position: relative;
  margin-top: 6px;
}

.searchable-select input {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #dbeefe;
  background: #fbfdff;
  font-size: 15px;
  color: #0b2540;
  transition: all 0.2s ease;
}
.searchable-select input:focus {
  border-color: var(--accent);
  outline: none;
  box-shadow: 0 0 0 3px rgba(11,95,255,0.15);
}

.searchable-select .options {
  display: none;
  position: absolute;
  top: calc(100% + 4px);
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: #fff;
  border: 1px solid #e6eefc;
  border-radius: 8px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.06);
  z-index: 1000;
}

.searchable-select .option {
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.15s;
}

.searchable-select .option:hover {
  background: #eef4ff;
}

</style>


<div class="container">
  <div class="card">
    <h2>CBT Platform — Login</h2>
    <p class="small">Choose Admin, Teacher or Student login below.</p>

    <div class="tabs">
      <div class="tab active" data-target="studentPanel">Student</div>
      <div class="tab" data-target="teacherPanel">Teacher</div>
      <div class="tab" data-target="adminPanel">Admin</div>
    </div>

    <div class="grid">
      <!-- Student panel (original) -->
      <div id="studentPanel" class="group active">
        <h3>Student login</h3>
        <p class="small">Select your class, then choose your name, then pick the test to start.</p>

        <div style="margin-top:12px">
          <label>Class</label><br/>
          <select id="classSelect"><option value="">Loading classes...</option></select>
        </div>

        <div style="margin-top:12px">
          <label>Name</label><br/>
          <div class="searchable-select">
            <input type="text" id="studentInput" placeholder="Type or choose name..." autocomplete="off" disabled>
            <div class="options" id="studentOptions"></div>
          </div>
        </div>


        <div style="margin-top:12px">
          <label>Test</label><br/>
          <select id="examSelect"><option value="">Loading open tests...</option></select>
        </div>

        <div style="margin-top:16px">
          <button id="startBtn">Start Test</button>
          <div id="loginMsg" class="small" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Teacher panel -->
      <div id="teacherPanel" class="group">
        <h3>Teacher login</h3>
        <p class="small">Enter your teacher account (must be approved by admin).</p>

        <div id="teacherAuth">
          <div style="margin-top:8px">
            <label>Name</label><br/>
            <input id="teacherName" type="text" placeholder="Teacher name" />
          </div>
          <div style="margin-top:8px">
            <label>Password</label><br/>
            <input id="teacherPass" type="password" placeholder="Password" />
          </div>
          <div style="margin-top:8px">
            <button id="teacherLoginBtn">Login as Teacher</button>
            <button id="showTeacherRegister" style="margin-left:8px;background:#fff;color:#0b5fff;border:1px solid #e6eefc">Register</button>
          </div>
          <div id="teacherMsg" class="small" style="margin-top:8px"></div>
        </div>

        <div id="teacherRegister" style="display:none">
          <p class="small">Register a new teacher account. Admin approval is required.</p>
          <div style="margin-top:8px">
            <label>Name</label><br/>
            <input id="regTeacherName" type="text" placeholder="Full name" />
          </div>
          <div style="margin-top:8px">
            <label>Password</label><br/>
            <input id="regTeacherPass" type="password" placeholder="Choose a password" />
          </div>
          <div style="margin-top:8px">
            <label>Subject (optional)</label><br/>
            <input id="regTeacherSubject" type="text" placeholder="e.g. Mathematics" />
          </div>
          <div style="margin-top:8px">
            <button id="teacherRegisterBtn">Register</button>
            <button id="cancelTeacherRegister" style="margin-left:8px;background:#fff;color:#0b5fff;border:1px solid #e6eefc">Cancel</button>
          </div>
          <div id="teacherRegMsg" class="small" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Admin panel -->
      <div id="adminPanel" class="group">
        <h3>Admin login</h3>
        <p class="small">Use admin credentials to manage approvals and exams.</p>
        <div style="margin-top:8px">
          <label>Username</label><br/>
          <input id="adminUser" type="text" placeholder="admin" />
        </div>
        <div style="margin-top:8px">
          <label>Password</label><br/>
          <input id="adminPass" type="password" placeholder="password" />
        </div>
        <div style="margin-top:12px">
          <button id="adminLoginBtn">Login as Admin</button>
          <div id="adminMsg" class="small" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// tabs
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', function(){
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.group').forEach(g=>g.classList.remove('active'));
  this.classList.add('active');
  document.getElementById(this.getAttribute('data-target')).classList.add('active');
}));

// Student functions (unchanged behavior)
async function loadClasses(){
  const sel = document.getElementById('classSelect');
  sel.innerHTML = '<option value="">Loading...</option>';
  const r = await fetch('/api/list_classes');
  if(!r.ok){ sel.innerHTML = '<option value="">(failed)</option>'; return; }
  const list = await r.json();
  sel.innerHTML = '<option value="">-- Select class --</option>';
  list.forEach(c => {
    const o = document.createElement('option'); o.value = c.name; o.text = c.name; sel.appendChild(o);
  });
}
document.getElementById('classSelect').addEventListener('change', async function(){
  const className = this.value;
  const s = document.getElementById('studentSelect');
  s.innerHTML = '<option value="">Loading...</option>';
  if(!className){ s.innerHTML = '<option value="">Select class first</option>'; return; }
  const r = await fetch('/api/list_class_students?class=' + encodeURIComponent(className));
  if(!r.ok){ s.innerHTML = '<option value="">(failed)</option>'; return; }
  const list = await r.json();
  s.innerHTML = '<option value="">-- Select name --</option>';
  list.forEach(st => { const o=document.createElement('option'); o.value=st.name; o.text=st.name; s.appendChild(o); });
});

async function loadOpenExams(){
  const sel = document.getElementById('examSelect');
  sel.innerHTML = '<option value="">Loading...</option>';
  const r = await fetch('/api/list_exams');
  if(!r.ok){ sel.innerHTML = '<option value="">(failed)</option>'; return; }
  const all = await r.json();
  const list = all.filter(e => e.started);
  sel.innerHTML = '<option value="">-- Select test --</option>';
  list.forEach(e => { const o=document.createElement('option'); o.value=e.id; o.text = e.title + (e.tag ? ' • ' + e.tag : ''); sel.appendChild(o); });
}

document.getElementById('startBtn').addEventListener('click', async function(){
  const className = document.getElementById('classSelect').value;
  const studentName = window.selectedStudent || document.getElementById('studentInput').value.trim();
  const examId = document.getElementById('examSelect').value;
  const msg = document.getElementById('loginMsg');
  if(!className){ msg.innerText = 'Choose your class'; return; }
  if(!studentName){ msg.innerText = 'Choose your name'; return; }
  if(!examId){ msg.innerText = 'Choose a test'; return; }

  const btn = document.getElementById('startBtn');
  btn.disabled = true;
  msg.innerText = 'Requesting test...';
  try{
    const res = await fetch('/api/start_exam', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ exam_id: examId, student_name: studentName, class: className })
    });
    const js = await res.json().catch(()=>({}));
    if(res.ok && js.token && js.url){
      window.location.href = js.url;
      return;
    }
    if(js && js.error === 'already_submitted'){
      msg.innerText = 'You have already submitted this exam.';
    } else if(js && js.error){
      msg.innerText = 'Start failed: ' + (js.message || js.error);
    } else {
      msg.innerText = 'Start failed: unknown error';
    }
  }catch(e){
    msg.innerText = 'Network error';
  }finally{
    btn.disabled = false;
  }
});

// Teacher login
document.getElementById('teacherLoginBtn').addEventListener('click', async () => {
  const name = document.getElementById('teacherName').value.trim();
  const pass = document.getElementById('teacherPass').value;
  const msg = document.getElementById('teacherMsg');
  if(!name || !pass){ msg.innerText = 'Name and password required'; return; }
  msg.innerText = 'Signing in...';
  try{
    const r = await fetch('/api/login_teacher', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({name, password: pass})
    });
    const js = await r.json().catch(()=>({}));
    if(r.ok && js.ok && js.teacher_token){
      localStorage.setItem('teacher_token', js.teacher_token);
      window.location.href = '/teacher';
      return;
    }
    msg.innerText = js.message || js.error || 'Login failed';
  }catch(e){
    msg.innerText = 'Network error';
  }
});

// show/hide register UI
document.getElementById('showTeacherRegister').addEventListener('click', () => {
  document.getElementById('teacherAuth').style.display = 'none';
  document.getElementById('teacherRegister').style.display = 'block';
});
document.getElementById('cancelTeacherRegister').addEventListener('click', () => {
  document.getElementById('teacherRegister').style.display = 'none';
  document.getElementById('teacherAuth').style.display = 'block';
});

// teacher registration
document.getElementById('teacherRegisterBtn').addEventListener('click', async () => {
  const name = (document.getElementById('regTeacherName').value || '').trim();
  const pass = document.getElementById('regTeacherPass').value || '';
  const subject = (document.getElementById('regTeacherSubject').value || '').trim();
  const msg = document.getElementById('teacherRegMsg');
  if(!name || !pass){ msg.innerText = 'Name and password required'; return; }
  msg.innerText = 'Registering...';
  try{
    const r = await fetch('/api/register_teacher', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ name, password: pass, subject })
    });
    const js = await r.json().catch(()=>({}));
    if(r.ok && js.ok){
      msg.innerText = 'Registered — awaiting admin approval';
      // reset and show login
      document.getElementById('regTeacherName').value = '';
      document.getElementById('regTeacherPass').value = '';
      document.getElementById('regTeacherSubject').value = '';
      setTimeout(()=> {
        document.getElementById('teacherRegister').style.display = 'none';
        document.getElementById('teacherAuth').style.display = 'block';
        document.getElementById('teacherMsg').innerText = 'Registration submitted — await approval';
      }, 1200);
      return;
    }
    msg.innerText = js.error || js.message || 'Registration failed';
  }catch(e){
    msg.innerText = 'Network error';
  }
});

// Admin login
document.getElementById('adminLoginBtn').addEventListener('click', async () => {
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value;
  const msg = document.getElementById('adminMsg');
  if(!user || !pass){ msg.innerText = 'Username and password required'; return; }
  msg.innerText = 'Signing in...';
  try{
    const r = await fetch('/api/login_admin', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({username: user, password: pass})
    });
    const js = await r.json().catch(()=>({}));
    if(r.ok && js.ok){
      // redirect to admin page (session cookie set by server)
      window.location.href = '/admin';
      return;
    }
    msg.innerText = js.message || js.error || 'Login failed';
  }catch(e){
    msg.innerText = 'Network error';
  }
});

document.getElementById('classSelect').addEventListener('change', async function(){
  const className = this.value;
  const input = document.getElementById('studentInput');
  const optionsDiv = document.getElementById('studentOptions');
  input.value = '';
  optionsDiv.innerHTML = '';
  if(!className){
    input.disabled = true;
    input.placeholder = 'Select class first';
    return;
  }
  input.disabled = false;
  input.placeholder = 'Type or choose name...';
  
  const r = await fetch('/api/list_class_students?class=' + encodeURIComponent(className));
  if(!r.ok){ 
    optionsDiv.innerHTML = '<div class="option">(failed)</div>';
    return; 
  }

  const list = await r.json();
  const allNames = list.map(st => st.name);
  window.studentNames = allNames; // store globally for search

  renderStudentOptions(allNames);
  
  // Input search filtering
  input.addEventListener('input', () => {
    const q = input.value.toLowerCase();
    const filtered = allNames.filter(n => n.toLowerCase().includes(q));
    renderStudentOptions(filtered);
  });

  // Show on focus
  input.addEventListener('focus', () => {
    if(allNames.length) {
      renderStudentOptions(allNames);
      optionsDiv.style.display = 'block';
    }
  });

  // Hide when clicking outside
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.searchable-select')) {
      optionsDiv.style.display = 'none';
    }
  });

  function renderStudentOptions(names) {
    optionsDiv.innerHTML = '';
    if (!names.length) { optionsDiv.style.display = 'none'; return; }
    names.forEach(name => {
      const div = document.createElement('div');
      div.className = 'option';
      div.textContent = name;
      div.addEventListener('click', () => {
        input.value = name;
        window.selectedStudent = name;
        optionsDiv.style.display = 'none';
      });
      optionsDiv.appendChild(div);
    });
    optionsDiv.style.display = 'block';
  }
});

loadClasses(); loadOpenExams();


</script>
{% endblock %}