<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teacher · CBT</title>
<style>
:root {
  --bg: #f8fbff;
  --card-bg: #ffffff;
  --muted: #6b7280;
  --accent: #0b5fff;
  --danger: #ef4444;
  --success: #059669;
  --border: #e6eefc;
  --shadow: 0 4px 16px rgba(11, 37, 64, 0.08);
}

body {
  font-family: "Inter", system-ui, Arial;
  background: var(--bg);
  color: #0b2540;
  margin: 0;
}

.header {
  background: var(--card-bg);
  border-bottom: 1px solid var(--border);
  padding: 14px 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: var(--shadow);
}
.header a {
  color: var(--accent);
  text-decoration: none;
  margin-right: 14px;
  font-weight: 500;
}
.header a:hover {
  text-decoration: underline;
}
.small {
  color: var(--muted);
  font-size: 13px;
}

.container {
  max-width: 960px;
  margin: 30px auto;
  padding: 0 16px;
}

.card {
  background: var(--card-bg);
  border-radius: 14px;
  padding: 20px;
  box-shadow: var(--shadow);
  margin-bottom: 20px;
}

h2, h3 {
  color: var(--accent);
  margin-top: 0;
}
h3 {
  margin-top: 24px;
  font-size: 1.1rem;
  border-left: 4px solid var(--accent);
  padding-left: 8px;
}

input, select, button {
  font-size: 14px;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1px solid var(--border);
}

button {
  background: var(--accent);
  color: white;
  border: none;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}
button:hover {
  background: #004ed9;
  transform: translateY(-1px);
}
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
button.link-btn {
  border: 1px solid var(--accent);
  background: #fff;
  color: var(--accent);
}
button.link-btn:hover {
  background: var(--accent);
  color: #fff;
}

.form-section {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-top: 10px;
}

#uploadQuestionsInfo {
  font-size: 14px;
  margin-top: 6px;
}
.success {
  color: var(--success);
}
.error {
  color: var(--danger);
}

.preview-box {
  display: none;
  max-height: 240px;
  overflow: auto;
  border: 1px dashed var(--border);
  border-radius: 8px;
  background: #fbfdff;
  padding: 10px;
  margin-top: 10px;
  font-size: 14px;
}

footer {
  text-align: center;
  font-size: 13px;
  color: var(--muted);
  margin-top: 30px;
  padding: 10px 0;
}
</style>
</head>
<body>
  {% extends "base.html" %}
  {% block title %}Teacher · CBT{% endblock %}
  {% block content %}
  
  <div class="header">
    <div>
      <a href="/"><strong>CBT</strong></a>
      <a href="/teacher">Teacher</a>
      <a href="/admin">Admin</a>
    </div>
    <div class="small">Signed in as: <span id="teacherName">-</span></div>
  </div>

  <div class="container">
    <div class="card">
      <h2>Teacher Dashboard</h2>
      <p class="small">Create exams, upload questions (with images), and manage your assessments.</p>

      <h3>Create a New Exam</h3>
      <div class="form-section">
        <input id="teacherCreateTitle" placeholder="Exam title" style="flex:1">
        <input id="teacherCreateDuration" type="number" value="30" min="1" style="width:100px">
        <input id="teacherCreateTag" placeholder="Tag (optional)" style="width:160px">
        <button id="teacherCreate">Create Exam</button>
      </div>

      <h3>Bulk Upload Questions</h3>
      <form id="uploadQuestionsForm" enctype="multipart/form-data" class="form-section">
        <input id="fileInput" type="file" name="file" accept=".csv,.xlsx,.xls,.docx" required>
        <input id="imageFiles" type="file" name="images" accept="image/*" multiple>
        <select id="uqExamSelect" required style="min-width:250px"></select>
        <button id="uploadBtn" type="submit">Upload</button>
        <button id="previewBtn" type="button" class="link-btn">Preview</button>
      </form>

      <div id="uploadQuestionsInfo" class="small"></div>
      <div id="previewTable" class="preview-box"></div>
    </div>
  </div>

  <footer>CBT Teacher Portal · Powered by CHRISTTech</footer>

<script>
function teacherToken(){ return localStorage.getItem('cbt:teacher_token'); }

async function loadExams(){
  const r = await fetch('/api/list_exams');
  const data = await r.json();
  const sel = document.getElementById('uqExamSelect'); sel.innerHTML='';
  data.forEach(e=>{
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.text = `${e.title} • ${e.started ? 'OPEN' : 'CLOSED'}${e.tag ? ' • ' + e.tag : ''}`;
    sel.appendChild(opt);
  });
}

document.getElementById('teacherCreate').addEventListener('click', async ()=>{
  const title = document.getElementById('teacherCreateTitle').value.trim();
  const duration = Number(document.getElementById('teacherCreateDuration').value) || 30;
  const tag = document.getElementById('teacherCreateTag').value.trim() || undefined;
  if(!title){ alert('Please enter a title'); return; }
  const res = await fetch('/api/teacher_create_exam', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'X-Teacher-Token': teacherToken() },
    body: JSON.stringify({ title, duration, tag })
  });
  const js = await res.json();
  if(js.ok){ alert('Exam created: ' + js.exam_id); loadExams(); }
  else alert(js.error || 'Failed to create exam');
});

document.getElementById('uploadQuestionsForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const sel = document.getElementById('uqExamSelect');
  const fileInput = document.getElementById('fileInput');
  const info = document.getElementById('uploadQuestionsInfo');
  const uploadBtn = document.getElementById('uploadBtn');
  if(!sel.value || !fileInput.files.length){ alert('Select exam and file'); return; }

  uploadBtn.disabled = true; uploadBtn.innerText = 'Uploading...';
  info.textContent = 'Uploading...';

  let overwrite = false;
  try{
    const qres = await fetch('/api/questions/' + sel.value, { headers: {'X-Teacher-Token': teacherToken()} });
    if(qres.ok){
      const qjs = await qres.json();
      if(qjs && qjs.length > 0){
        overwrite = confirm(`Exam already has ${qjs.length} question(s).\nOK to overwrite, Cancel to append.`);
      }
    }
  }catch(e){}

  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  fd.append('exam_id', sel.value);
  fd.append('overwrite', overwrite ? '1' : '0');

  const imageInput = document.getElementById('imageFiles');
  if(imageInput && imageInput.files.length > 0){
    for(const img of imageInput.files){ fd.append('images', img); }
  }

  try{
    const headers = {}; const tk = teacherToken(); if(tk) headers['X-Teacher-Token'] = tk;
    const res = await fetch('/api/upload_questions', { method:'POST', body: fd, headers });
    const json = await res.json().catch(()=>({ok: res.ok}));
    if(json && json.ok){
      info.className = 'small success';
      info.textContent = `Successfully imported ${json.count} question(s).`;
      fileInput.value = '';
      document.getElementById('previewTable').style.display = 'none';
    } else {
      info.className = 'small error';
      info.textContent = 'Upload failed: ' + (json.error || 'Server error');
    }
  }catch(e){
    info.className = 'small error';
    info.textContent = 'Upload failed (network error)';
  }finally{
    uploadBtn.disabled = false; uploadBtn.innerText = 'Upload';
  }
});

document.getElementById('previewBtn').addEventListener('click', async ()=>{
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('previewTable');
  if(!fileInput.files.length){ preview.innerText = 'No file selected'; preview.style.display='block'; return; }
  const file = fileInput.files[0];
  const name = file.name.toLowerCase();
  preview.style.display = 'block';
  preview.innerText = 'Parsing preview...';

  try{
    if(name.endsWith('.csv') || name.endsWith('.txt')){
      const text = await file.text();
      const rows = text.split(/\r?\n/).filter(Boolean);
      if(rows.length===0){ preview.innerText='No rows'; return; }
      const header = rows[0].split(',').map(s=>s.trim());
      const sample = rows.slice(1,7).map(r=> r.split(',').map(s=>s.trim()).slice(0,6));
      let html = `<strong>Detected columns:</strong> ${header.join(', ')}<br><pre>`;
      sample.forEach(r=> html += r.join(' | ') + '\n');
      html += '</pre>';
      preview.innerHTML = html;
    }else{
      preview.innerText = 'Preview not available for this file type.';
    }
  }catch(e){
    preview.innerText = 'Preview failed.';
  }
});

loadExams();
</script>
{% endblock %}
</body>
</html>
