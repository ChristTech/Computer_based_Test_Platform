<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Teacher</title>
<style>
:root{--muted:#6b7280;--accent:#0b5fff;--danger:#ef4444}
body{font-family:Inter,system-ui,Arial;margin:0;background:#f7fbff}
.header{background:#fff;border-bottom:1px solid #eef4ff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.header a{color:var(--accent);text-decoration:none;margin-right:12px}
.container{max-width:980px;margin:24px auto;padding:16px}
.card{background:#fff;padding:16px;border-radius:8px}
.row{display:flex;gap:12px;align-items:center}
input,textarea,select,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #e6eefc}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
button:disabled{opacity:0.6;cursor:not-allowed}
button.link-btn{border:1px solid var(--accent);background:#fff;color:var(--accent)}
.small{color:var(--muted);font-size:13px}
.preview{margin-top:8px;border:1px dashed #e6eefc;padding:8px;border-radius:6px;background:#fbfdff}
.error{background:#fef2f2;border-color:#ef4444}
.success{background:#ecfdf5;border-color:#10b981;color:#059669}
.scores-table { width:100%; border-collapse: collapse; margin-top:8px; font-size:14px; }
.scores-table th, .scores-table td { padding:12px; text-align:left; border-bottom:1px solid #eef4ff; }
.scores-table th { background:#fbfdff; font-weight:600; color:var(--accent); }
.scores-table tr:hover { background:#fbfdff; }
.scores-table tbody tr:nth-child(even) { background:#fafbff; }
.status-badge { padding:4px 8px; border-radius:4px; font-size:12px; font-weight:500; }
.status-pass { background:#ecfdf5; color:#059669; }
.status-fail { background:#fef2f2; color:var(--danger); }
#scoresSummary { margin-bottom:12px; font-weight:500; color:var(--accent); }
</style>
</head>
<body>
  {% extends "base.html" %}
  {% block title %}Teacher · CBT{% endblock %}
  {% block content %}
  <style>
:root{--muted:#6b7280;--accent:#0b5fff;--danger:#ef4444}
.header{background:#fff;border-bottom:1px solid #eef4ff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.header a{color:var(--accent);text-decoration:none;margin-right:12px}
.container{max-width:980px;margin:24px auto;padding:16px}
.card{background:#fff;padding:16px;border-radius:8px}
.row{display:flex;gap:12px;align-items:center}
input,textarea,select,button{font-size:14px;padding:8px;border-radius:6px;border:1px solid #e6eefc}
button{background:var(--accent);color:#fff;border:none;cursor:pointer}
button:disabled{opacity:0.6;cursor:not-allowed}
button.link-btn{border:1px solid var(--accent);background:#fff;color:var(--accent)}
.small{color:var(--muted);font-size:13px}
.preview{margin-top:8px;border:1px dashed #e6eefc;padding:8px;border-radius:6px;background:#fbfdff}
.error{background:#fef2f2;border-color:#ef4444}
.success{background:#ecfdf5;border-color:#10b981;color:#059669}
.scores-table { width:100%; border-collapse: collapse; margin-top:8px; font-size:14px; }
.scores-table th, .scores-table td { padding:12px; text-align:left; border-bottom:1px solid #eef4ff; }
.scores-table th { background:#fbfdff; font-weight:600; color:var(--accent); }
.scores-table tr:hover { background:#fbfdff; }
.scores-table tbody tr:nth-child(even) { background:#fafbff; }
.status-badge { padding:4px 8px; border-radius:4px; font-size:12px; font-weight:500; }
.status-pass { background:#ecfdf5; color:#059669; }
.status-fail { background:#fef2f2; color:var(--danger); }
#scoresSummary { margin-bottom:12px; font-weight:500; color:var(--accent); }
</style>

<div class="header">
  <div><a href="/"><strong>CBT</strong></a><a href="/teacher">Teacher</a><a href="/admin">Admin</a></div>
  <div class="small">Signed in: <span id="teacherName">-</span></div>
</div>

<div class="container">
  <div class="card">
    <h2>Teacher</h2>
    <p class="small">Create exams and bulk-upload questions. You will be prompted to overwrite or append if questions already exist.</p>

    <h3 style="margin-top:12px">Create exam</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="teacherCreateTitle" placeholder="Exam title" style="flex:1;padding:8px;border-radius:6px;border:1px solid #e6eefc"/>
      <input id="teacherCreateDuration" type="number" value="30" style="width:110px;padding:8px;border-radius:6px;border:1px solid #e6eefc"/>
      <input id="teacherCreateTag" placeholder="Tag (optional)" style="width:180px;padding:8px;border-radius:6px;border:1px solid #e6eefc"/>
      <button id="teacherCreate" class="btn">Create</button>
    </div>

    <h3 style="margin-top:12px">Bulk upload questions (CSV / XLSX / DOCX)</h3>
    <form id="uploadQuestionsForm" enctype="multipart/form-data" style="display:flex;gap:8px;align-items:center">
      <input id="fileInput" type="file" name="file" accept=".csv,.xlsx,.xls,.docx" required />
      <select id="uqExamSelect" style="min-width:260px"></select>
      <button id="uploadBtn" type="submit" class="btn">Upload Questions</button>
      <button id="previewBtn" type="button" class="link-btn">Preview</button>
    </form>
    <div id="uploadQuestionsInfo" class="small" style="margin-top:8px"></div>
    <div id="previewTable" class="small" style="margin-top:8px;display:none;max-height:260px;overflow:auto;border:1px dashed #e6eefc;padding:8px;border-radius:6px"></div>
  </div>
</div>

<script>
function teacherToken(){ return localStorage.getItem('cbt:teacher_token'); }

async function loadExams(){
  const r = await fetch('/api/list_exams');
  const data = await r.json();
  const sel = document.getElementById('uqExamSelect'); sel.innerHTML='';
  data.forEach(e=>{
    const opt = document.createElement('option');
    opt.value = e.id;
    opt.text = `${e.title} • ${e.started ? 'OPEN' : 'CLOSED'}${e.tag ? ' • ' + e.tag : ''}`;
    sel.appendChild(opt);
  });
}
document.getElementById('teacherCreate').addEventListener('click', async ()=>{
  const title = document.getElementById('teacherCreateTitle').value.trim();
  const duration = Number(document.getElementById('teacherCreateDuration').value) || 30;
  const tag = document.getElementById('teacherCreateTag').value.trim() || undefined;
  if(!title){ alert('enter title'); return; }
  const res = await fetch('/api/teacher_create_exam', { method:'POST', headers:{ 'Content-Type':'application/json', 'X-Teacher-Token': teacherToken() }, body: JSON.stringify({ title, duration, tag })});
  const js = await res.json();
  if(js.ok){ alert('Created exam: ' + js.exam_id); loadExams(); } else alert(js.error || 'failed');
});

document.getElementById('uploadQuestionsForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const sel = document.getElementById('uqExamSelect');
  if(!sel || !sel.value){ alert('Select exam'); return; }
  const fileInput = document.getElementById('fileInput');
  if(!fileInput.files.length){ alert('Choose a file'); return; }
  const info = document.getElementById('uploadQuestionsInfo');
  const uploadBtn = document.getElementById('uploadBtn');
  uploadBtn.disabled = true; uploadBtn.innerText = 'Uploading...';
  info.innerText = 'Uploading...';

  // check existing questions count
  let overwrite = false;
  try{
    const qres = await fetch('/api/questions/' + sel.value, { headers: {'X-Teacher-Token': teacherToken()} });
    if(qres.ok){
      const qjs = await qres.json();
      if(qjs && qjs.length > 0){
        overwrite = confirm(`This exam already has ${qjs.length} question(s).\nPress OK to OVERWRITE them, Cancel to APPEND.`);
      }
    }
  }catch(e){ /* ignore, default to append */ }

  const fd = new FormData();
  fd.append('file', fileInput.files[0]);
  fd.append('exam_id', sel.value);
  fd.append('overwrite', overwrite ? '1' : '0');

  try{
    const headers = {}; const tk = teacherToken(); if(tk) headers['X-Teacher-Token'] = tk;
    const res = await fetch('/api/upload_questions', { method:'POST', body: fd, headers });
    const json = await res.json().catch(()=>({ok: res.ok}));
    if(json && json.ok){
      info.style.color = '#059669';
      info.innerText = `Imported ${json.count} questions`;
      document.getElementById('previewTable').style.display = 'none';
      fileInput.value = '';
    }else{
      info.style.color = '#ef4444';
      info.innerText = 'Upload failed: ' + (json.error || 'server error');
    }
  }catch(e){
    info.style.color = '#ef4444';
    info.innerText = 'Upload failed (network)';
    console.error(e);
  } finally {
    uploadBtn.disabled = false; uploadBtn.innerText = 'Upload Questions';
  }
});

document.getElementById('previewBtn').addEventListener('click', async ()=>{
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('previewTable');
  const info = document.getElementById('uploadQuestionsInfo');
  preview.style.display = 'block';
  info.innerText = '';
  if(!fileInput.files.length){ preview.innerText = 'No file'; return; }
  const file = fileInput.files[0];
  const name = file.name.toLowerCase();
  preview.innerText = 'Parsing preview...';
  try{
    if(name.endsWith('.csv') || name.endsWith('.txt')){
      const text = await file.text();
      const rows = text.split(/\r?\n/).filter(Boolean);
      if(rows.length===0){ preview.innerText='No rows'; return; }
      const header = rows[0].split(',').map(s=>s.trim());
      const sample = rows.slice(1,7).map(r=> r.split(',').map(s=>s.trim()).slice(0,6));
      let html = `<div><strong>Detected columns:</strong> ${header.join(', ')}</div><pre style="white-space:pre-wrap;margin-top:8px">`;
      sample.forEach(r=> html += r.join(' | ') + '\n');
      html += '</pre>';
      preview.innerHTML = html;
    }else if((name.endsWith('.xlsx') || name.endsWith('.xls')) && window.FileReader){
      preview.innerText = 'Preview for Excel not available in-browser. Upload to server preview if needed.';
    }else{
      preview.innerText = 'Preview not available for this file type.';
    }
  }catch(e){
    preview.innerText = 'Preview failed';
  }
});

loadExams();
</script>
{% endblock %}
</body>
</html>