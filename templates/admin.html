<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CBT Admin</title>
<style>
:root{--muted:#6b7280;--accent:#0b5fff}
body{font-family:Inter,system-ui,Arial;margin:20px;background:#f7fbff}
.wrap{max-width:980px;margin:14px auto}
.card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.small{color:var(--muted);font-size:13px}
.link-btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#0b5fff;color:#fff;text-decoration:none;border:none;cursor:pointer}
.exam-row{padding:10px;border:1px solid #eef4ff;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.meta{color:#666;font-size:13px;margin-top:6px}
.subject-chip{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:6px;background:#fbfdff;border:1px solid #eef4ff}
</style>
</head>
<body>
{% extends "base.html" %}
{% block title %}Admin · CBT{% endblock %}
{% block content %}
<style>
:root{--muted:#6b7280;--accent:#0b5fff}
.wrap{max-width:980px;margin:14px auto}
.card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.small{color:var(--muted);font-size:13px}
.link-btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#0b5fff;color:#fff;text-decoration:none;border:none;cursor:pointer}
.exam-row{padding:10px;border:1px solid #eef4ff;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.meta{color:#666;font-size:13px;margin-top:6px}
.subject-chip{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:6px;background:#fbfdff;border:1px solid #eef4ff}
</style>

<div class="wrap">
  <div class="card">
    <h2>Admin</h2>
    <p class="small">Manage exams and download results by subject (one click).</p>

    <hr style="margin:12px 0"/>

    <h3>Exams</h3>
    <div id="examList" class="small" style="margin-top:8px">Loading exams...</div>

    <hr style="margin:12px 0"/>

    <h3>Pending teachers</h3>
    <div id="pendingTeachers" class="small" style="margin-top:8px">Loading...</div>
  </div>
</div>

<script>
async function ensureAdminOrRedirect(){
  try{
    const r = await fetch('/api/check_admin');
    const js = await r.json().catch(()=>({is_admin:false}));
    if(!js.is_admin) { window.location.href = '/login'; return false; }
    return true;
  }catch(e){
    window.location.href = '/login';
    return false;
  }
}

async function loadExams(){
  const out = document.getElementById('examList');
  out.innerText = 'Loading exams...';
  try{
    const r = await fetch('/api/list_exams');
    if(!r.ok){ out.innerText = 'Failed to load exams'; return; }
    const list = await r.json();
    if(!list || !list.length){ out.innerText = 'No exams'; return; }
    out.innerHTML = '';
    list.forEach(e=>{
      const div = document.createElement('div');
      div.className = 'exam-row';
      const left = document.createElement('div');
      left.style.flex = '1';
      left.innerHTML = `<div style="font-weight:600">${e.title} <span style="font-weight:400;color:#666">(${e.id})</span></div>
                        <div class="meta">Duration: ${e.duration_minutes} mins · State: <strong>${e.started ? 'Open' : 'Closed'}</strong></div>`;
      const right = document.createElement('div');
      right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

      // subject + download button (if subject exists)
      const subj = e.subject || '';
      if(subj){
        const subjWrap = document.createElement('div');
        subjWrap.className = 'subject-chip';
        subjWrap.innerHTML = `<span style="font-weight:600">${subj}</span>`;
        const dlBtn = document.createElement('button');
        dlBtn.className = 'link-btn download-subject';
        dlBtn.dataset.subject = subj;
        dlBtn.dataset.exam = e.id;                // pass exam id too
        dlBtn.dataset.format = 'csv';
        dlBtn.innerText = 'Download';
        subjWrap.appendChild(dlBtn);
        right.appendChild(subjWrap);
      } else {
        const noSub = document.createElement('div');
        noSub.style.color = '#999';
        noSub.innerText = '(no subject)';
        right.appendChild(noSub);
      }

      // Open/Close toggle kept
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'link-btn toggle';
      toggleBtn.style.background = '#111827';
      toggleBtn.dataset.id = e.id;
      toggleBtn.dataset.started = e.started ? '1':'0';
      toggleBtn.innerText = e.started ? 'Close' : 'Open';
      right.appendChild(toggleBtn);

      div.appendChild(left); div.appendChild(right); out.appendChild(div);
    });

    // attach toggle handlers
    document.querySelectorAll('.toggle').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        const id = ev.currentTarget.dataset.id;
        const started = ev.currentTarget.dataset.started === '1';
        const wantOpen = !started;
        if(!await ensureAdminOrRedirect()) return;
        try{
          const res = await fetch('/api/set_exam_state', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ exam_id: id, started: wantOpen })
          });
          const js = await res.json().catch(()=>({}));
          if(res.ok && js.ok){ loadExams(); } else { alert('Update failed: ' + (js.error || 'unknown')); }
        }catch(err){ alert('Update failed (network)'); }
      });
    });

  }catch(e){
    out.innerText = 'Failed to load exams';
  }
}

// subject download handler (one click, admin session required)
document.addEventListener('click', function(ev){
  const btn = ev.target.closest && ev.target.closest('.download-subject');
  if(!btn) return;
  const subj = btn.dataset.subject;
  const fmt = btn.dataset.format || 'csv';
  const examId = btn.dataset.exam || '';
  if(!subj && !examId) return;
  ensureAdminOrRedirect().then(ok=>{
    if(!ok) return;
    // include exam_id as fallback — server will prefer exam_id to resolve correct subject
    const url = '/api/download_subject?subject=' + encodeURIComponent(subj) + '&exam_id=' + encodeURIComponent(examId) + '&format=' + encodeURIComponent(fmt);
    window.open(url, '_blank');
  });
});

// pending teachers (unchanged)
async function loadPending(){
  const out = document.getElementById('pendingTeachers');
  out.innerText = 'Loading...';
  try{
    const r = await fetch('/api/pending_teachers');
    if(!r.ok){ out.innerText = 'Failed to load'; return; }
    const list = await r.json();
    if(!list || !list.length){ out.innerText = 'No pending teachers'; return; }
    out.innerHTML = '';
    list.forEach(t=>{
      const div = document.createElement('div'); div.style.marginBottom='8px';
      div.innerHTML = `<div style="padding:10px;border:1px solid #eef4ff;border-radius:8px">
        <div style="font-weight:600">${t.name} <span style="font-weight:400;color:#666">• ${t.subject || ''}</span></div>
        <div class="small" style="margin-top:6px">id: ${t.id}</div>
        <div style="margin-top:8px"><button class="link-btn approve" data-id="${t.id}">Approve</button></div>
      </div>`;
      out.appendChild(div);
    });
    document.querySelectorAll('.approve').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        const id = ev.target.dataset.id;
        const pw = prompt('Admin password:');
        if(pw===null) return;
        const res = await fetch('/api/approve_teacher', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({teacher_id: id, admin_password: pw})});
        const js = await res.json().catch(()=>({}));
        if(js && js.ok){ alert('Teacher approved. Token: ' + js.teacher_token); loadPending(); loadExams(); } else { alert('Approve failed: ' + (js.error||'unknown')); }
      });
    });
  }catch(e){ out.innerText = 'Failed to load'; }
}

loadExams(); loadPending();
</script>
{% endblock %}
</body>
</html>

