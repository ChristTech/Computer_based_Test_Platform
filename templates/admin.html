<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CBT Admin</title>
<style>
:root{--muted:#6b7280;--accent:#0b5fff}
body{font-family:Inter,system-ui,Arial;margin:20px;background:#f7fbff}
.wrap{max-width:980px;margin:14px auto}
.card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.small{color:var(--muted);font-size:13px}
.link-btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#0b5fff;color:#fff;text-decoration:none;border:none;cursor:pointer}
.exam-row{padding:10px;border:1px solid #eef4ff;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.meta{color:#666;font-size:13px;margin-top:6px}
.subject-chip{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:6px;background:#fbfdff;border:1px solid #eef4ff}
</style>
</head>
<body>
{% extends "base.html" %}
{% block title %}Admin · CBT{% endblock %}
{% block content %}
<style>
:root{--muted:#6b7280;--accent:#0b5fff}
.wrap{max-width:980px;margin:14px auto}
.card{background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
.small{color:var(--muted);font-size:13px}
.link-btn{display:inline-block;padding:8px 12px;border-radius:6px;background:#0b5fff;color:#fff;text-decoration:none;border:none;cursor:pointer}
.exam-row{padding:10px;border:1px solid #eef4ff;border-radius:6px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.meta{color:#666;font-size:13px;margin-top:6px}
.subject-chip{display:inline-flex;gap:8px;align-items:center;padding:6px;border-radius:6px;background:#fbfdff;border:1px solid #eef4ff}
</style>

<div class="wrap">
  <div class="card">
    <h2>Admin</h2>
    <p class="small">Manage exams and download results by subject (one click).</p>

    <hr style="margin:12px 0"/>

    <h3>Exams</h3>
    <div id="examList" class="small" style="margin-top:8px">Loading exams...</div>

    <hr style="margin:12px 0"/>

    <h3>Pending teachers</h3>
    <div id="pendingTeachers" class="small" style="margin-top:8px">Loading...</div>

    <hr style="margin:12px 0"/>

    <hr style="margin:12px 0"/>

    <h3>Download Class Results</h3>
    <div class="small" style="margin-top:8px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="classInput" placeholder="Enter class (e.g. SS1)" 
              style="padding:8px;border-radius:6px;border:1px solid #e6eefc;flex:1;min-width:200px">
        <button id="downloadResultsBtn" class="link-btn">Download Excel</button>
      </div>
      <div id="downloadStatus" class="small" style="margin-top:6px;color:#6b7280;"></div>
    </div>


    <h3>Classes</h3>
    <div class="small" style="margin-top:8px">
      <div style="margin-bottom:10px">
        <label><strong>Create class</strong></label><br/>
        <input id="newClassName" placeholder="e.g. SS1" style="padding:8px;border-radius:6px;border:1px solid #e6eefc"/>
        <button id="createClassBtn" class="link-btn" style="margin-left:8px">Create</button>
        <span id="createClassMsg" class="small" style="margin-left:8px"></span>
      </div>

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <div style="flex:1">
          <label><strong>Class</strong></label><br/>
          <select id="adminClassSelect" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eefc">
            <option value="">Loading classes...</option>
          </select>
        </div>
        <div style="flex:1">
          <label><strong>Add student to class</strong></label><br/>
          <input id="newStudentName" placeholder="Student name" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6eefc"/>
        </div>
        <div style="align-self:flex-end">
          <button id="addStudentBtn" class="link-btn">Add</button>
        </div>
      </div>

      <div id="classStudentsList" class="small" style="margin-top:8px">Select a class to view students.</div>
    </div>
  </div>
</div>

<script>
async function ensureAdminOrRedirect(){
  try{
    const r = await fetch('/api/check_admin');
    const js = await r.json().catch(()=>({is_admin:false}));
    if(!js.is_admin) { window.location.href = '/login'; return false; }
    return true;
  }catch(e){
    window.location.href = '/login';
    return false;
  }
}

async function loadExams(){
  const out = document.getElementById('examList');
  out.innerText = 'Loading exams...';
  try{
    const r = await fetch('/api/list_exams');
    if(!r.ok){ out.innerText = 'Failed to load exams'; return; }
    const list = await r.json();
    if(!list || !list.length){ out.innerText = 'No exams'; return; }
    out.innerHTML = '';
    list.forEach(e=>{
      const div = document.createElement('div');
      div.className = 'exam-row';
      const left = document.createElement('div');
      left.style.flex = '1';
      left.innerHTML = `<div style="font-weight:600">${e.title} <span style="font-weight:400;color:#666">(${e.id})</span></div>
                        <div class="meta">Duration: ${e.duration_minutes} mins · State: <strong>${e.started ? 'Open' : 'Closed'}</strong></div>`;
      const right = document.createElement('div');
      right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

      // subject + download button (if subject exists)
      const subj = e.subject || '';
      if(subj){
        const subjWrap = document.createElement('div');
        subjWrap.className = 'subject-chip';
        subjWrap.innerHTML = `<span style="font-weight:600">${subj}</span>`;
        const dlBtn = document.createElement('button');
        dlBtn.className = 'link-btn download-subject';
        dlBtn.dataset.subject = subj;
        dlBtn.dataset.exam = e.id;                // pass exam id too
        dlBtn.dataset.format = 'csv';
        dlBtn.innerText = 'Download';
        subjWrap.appendChild(dlBtn);
        right.appendChild(subjWrap);
      } else {
        const noSub = document.createElement('div');
        noSub.style.color = '#999';
        noSub.innerText = '(no subject)';
        right.appendChild(noSub);
      }

      // Open/Close toggle kept
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'link-btn toggle';
      toggleBtn.style.background = '#111827';
      toggleBtn.dataset.id = e.id;
      toggleBtn.dataset.started = e.started ? '1':'0';
      toggleBtn.innerText = e.started ? 'Close' : 'Open';
      right.appendChild(toggleBtn);

      div.appendChild(left); div.appendChild(right); out.appendChild(div);
    });

    // attach toggle handlers
    document.querySelectorAll('.toggle').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        const id = ev.currentTarget.dataset.id;
        const started = ev.currentTarget.dataset.started === '1';
        const wantOpen = !started;
        if(!await ensureAdminOrRedirect()) return;
        try{
          const res = await fetch('/api/set_exam_state', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ exam_id: id, started: wantOpen })
          });
          const js = await res.json().catch(()=>({}));
          if(res.ok && js.ok){ loadExams(); } else { alert('Update failed: ' + (js.error || 'unknown')); }
        }catch(err){ alert('Update failed (network)'); }
      });
    });

  }catch(e){
    out.innerText = 'Failed to load exams';
  }
}

// subject download handler (one click, admin session required)
document.addEventListener('click', function(ev){
  const btn = ev.target.closest && ev.target.closest('.download-subject');
  if(!btn) return;
  const subj = btn.dataset.subject;
  const fmt = btn.dataset.format || 'csv';
  const examId = btn.dataset.exam || '';
  if(!subj && !examId) return;
  ensureAdminOrRedirect().then(ok=>{
    if(!ok) return;
    // include exam_id as fallback — server will prefer exam_id to resolve correct subject
    const url = '/api/download_subject?subject=' + encodeURIComponent(subj) + '&exam_id=' + encodeURIComponent(examId) + '&format=' + encodeURIComponent(fmt);
    window.open(url, '_blank');
  });
});

    // pending teachers (unchanged)
    async function loadPending(){
      const out = document.getElementById('pendingTeachers');
      out.innerText = 'Loading...';
      try{
        const r = await fetch('/api/pending_teachers');
        if(!r.ok){ out.innerText = 'Failed to load'; return; }
        const list = await r.json();
        if(!list || !list.length){ out.innerText = 'No pending teachers'; return; }
        out.innerHTML = '';
        list.forEach(t=>{
          const div = document.createElement('div'); div.style.marginBottom='8px';
          div.innerHTML = `<div style="padding:10px;border:1px solid #eef4ff;border-radius:8px">
            <div style="font-weight:600">${t.name} <span style="font-weight:400;color:#666">• ${t.subject || ''}</span></div>
            <div class="small" style="margin-top:6px">id: ${t.id}</div>
            <div style="margin-top:8px"><button class="link-btn approve" data-id="${t.id}">Approve</button></div>
          </div>`;
          out.appendChild(div);
        });
        document.querySelectorAll('.approve').forEach(btn=>{
          btn.addEventListener('click', async (ev)=>{
            const id = ev.target.dataset.id;
            const pw = prompt('Admin password:');
            if(pw===null) return;
            const res = await fetch('/api/approve_teacher', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({teacher_id: id, admin_password: pw})});
            const js = await res.json().catch(()=>({}));
            if(js && js.ok){ alert('Teacher approved. Token: ' + js.teacher_token); loadPending(); loadExams(); } else { alert('Approve failed: ' + (js.error||'unknown')); }
          });
        });
      }catch(e){ out.innerText = 'Failed to load'; }
    }

    async function loadClassesAdmin(){
      const sel = document.getElementById('adminClassSelect');
      sel.innerHTML = '<option value="">Loading...</option>';
      try{
        const r = await fetch('/api/list_classes');
        if(!r.ok){ sel.innerHTML = '<option value="">(failed)</option>'; return; }
        const list = await r.json();
        sel.innerHTML = '<option value="">-- Select class --</option>';
        list.forEach(c => {
          const o = document.createElement('option'); o.value = c.name; o.text = c.name; sel.appendChild(o);
        });
        sel.addEventListener('change', ()=> loadClassStudents(sel.value));
      }catch(e){
        sel.innerHTML = '<option value="">(error)</option>';
      }
    }

    async function createClass(){
      if(!await ensureAdminOrRedirect()) return;
      const name = (document.getElementById('newClassName').value || '').trim();
      const msg = document.getElementById('createClassMsg');
      if(!name){ msg.innerText = 'Name required'; return; }
      msg.innerText = 'Creating...';
      try{
        const r = await fetch('/api/create_class', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name})
        });
        const js = await r.json().catch(()=>({}));
        if(r.ok && js.ok){
          msg.innerText = 'Created';
          document.getElementById('newClassName').value = '';
          loadClassesAdmin();
        } else {
          msg.innerText = js.error || 'failed';
        }
      }catch(e){ msg.innerText = 'network'; }
      setTimeout(()=>{ msg.innerText = ''; }, 2500);
    }

    async function loadClassStudents(className){
      const out = document.getElementById('classStudentsList');
      if(!className){ out.innerText = 'Select a class to view students.'; return; }
      out.innerText = 'Loading...';
      try{
        const r = await fetch('/api/list_class_students?class=' + encodeURIComponent(className));
        if(!r.ok){ out.innerText = 'Failed to load'; return; }
        const list = await r.json();
        if(!list || !list.length){ out.innerText = 'No students in ' + className; return; }
        out.innerHTML = '';
        list.forEach(s=>{
          const div = document.createElement('div');
          div.style.padding='8px'; div.style.border='1px solid #eef4ff'; div.style.borderRadius='6px'; div.style.marginBottom='6px';
          div.innerHTML = `<strong>${s.name}</strong> <span class="small" style="margin-left:8px;color:#666">id: ${s.id}</span>`;
          out.appendChild(div);
        });
      }catch(e){ out.innerText = 'Failed to load'; }
    }

    async function addStudentToClass(){
      if(!await ensureAdminOrRedirect()) return;
      const className = (document.getElementById('adminClassSelect').value || '').trim();
      const studentName = (document.getElementById('newStudentName').value || '').trim();
      const out = document.getElementById('classStudentsList');
      if(!className){ out.innerText = 'Choose a class first'; return; }
      if(!studentName){ out.innerText = 'Enter student name'; return; }
      try{
        const r = await fetch('/api/add_class_student', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ class: className, student_name: studentName })
        });
        const js = await r.json().catch(()=>({}));
        if(r.ok && js.ok){
          document.getElementById('newStudentName').value = '';
          loadClassStudents(className);
        } else {
          out.innerText = js.error || 'failed to add';
        }
      }catch(e){ out.innerText = 'network error'; }
    }

    document.getElementById('createClassBtn').addEventListener('click', createClass);
    document.getElementById('addStudentBtn').addEventListener('click', addStudentToClass);

    loadExams(); loadPending();
    loadClassesAdmin();
    // --- Download All Results per Class ---
    document.getElementById('downloadResultsBtn').addEventListener('click', async ()=>{
      const cls = document.getElementById('classInput').value.trim();
      const status = document.getElementById('downloadStatus');
      if(!cls){ alert('Enter a class name'); return; }

      status.textContent = 'Preparing Excel file...';
      status.style.color = '#6b7280';

      try{
        const res = await fetch(`/api/admin/download_results?class=${encodeURIComponent(cls)}`);
        if(!res.ok){
          const err = await res.json().catch(()=>({error:'Server error'}));
          status.textContent = 'Error: ' + (err.error || 'Unknown');
          status.style.color = '#ef4444';
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${cls}_All_Results.xlsx`;
        a.click();
        window.URL.revokeObjectURL(url);
        status.textContent = 'Download started.';
        status.style.color = '#059669';
      }catch(e){
        console.error(e);
        status.textContent = 'Failed to download results.';
        status.style.color = '#ef4444';
      }
    });



   </script>
{% endblock %}
</body>
</html>

