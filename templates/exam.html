<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>{{ title|escape }}</title>
<style>
:root{--muted:#6b7280;--accent:#0b5fff;--danger:#ef4444;--success:#059669;--bg:#f7fbff;--card-bg:#fff;--shadow:0 6px 18px rgba(2,6,23,0.06)}
body{font-family:Inter,system-ui,Arial;margin:0;background:var(--bg);color:#0b2540}
.header{background:var(--card-bg);border-bottom:1px solid #eef4ff;padding:12px 20px;display:flex;justify-content:space-between;align-items:center}
.header a{color:var(--accent);text-decoration:none;margin-right:12px}
.container{max-width:980px;margin:24px auto;padding:16px}
.card{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:var(--shadow)}
.question{transition:opacity 0.3s ease, transform 0.3s ease;opacity:0;transform:translateY(10px);animation:fadeIn 0.3s forwards}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
.timer{font-weight:600;margin-bottom:16px;color:#0b2540}
.small{color:var(--muted);font-size:13px}
.disabled{opacity:.6;pointer-events:none}
.draft{font-size:13px;color:var(--success);margin-left:8px;transition:color 0.3s}
.progress-bar{height:10px;background:#eef4ff;border-radius:5px;overflow:hidden;margin-bottom:12px;box-shadow:inset 0 1px 2px rgba(0,0,0,0.05)}
#progressFill{height:100%;background:var(--accent);transition:width 0.3s ease}
button{background:var(--accent);color:#fff;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;transition:background 0.2s, transform 0.1s}
button:hover{background:#0056b3;transform:translateY(-1px)}
button:active{transform:translateY(1px)}
button.nav-btn{background:#fff;border:1px solid var(--accent);color:var(--accent)}
button.nav-btn:hover{background:var(--accent);color:#fff}
#reviewBtn{border:1px solid #dbeefe;background:#fff;color:var(--accent);margin-right:8px}
.question-counter{font-weight:500;margin-bottom:12px;color:var(--muted)}
.label{display:block;margin:8px 0;cursor:pointer}
.label input{margin-right:8px}
#unansweredList{max-height:200px;overflow:auto;border:1px solid #eef4ff;padding:8px;border-radius:6px;background:#fbfdff;margin-top:12px}
#unansweredList div{margin-bottom:4px;cursor:pointer;color:var(--accent)}
#unansweredList div:hover{text-decoration:underline}
.error-notice{background:#fef2f2;border:1px solid var(--danger);padding:12px;border-radius:8px;margin-bottom:16px}
@media (max-width:600px){.row{flex-direction:column}.nav-buttons{justify-content:center;gap:8px}}

/* Calculator popup styles (light theme + smooth animation) */
.calc-popup {
  position: fixed;
  top: 50%;
  right: -380px; /* hidden off-screen by default */
  transform: translateY(-50%);
  width: 340px;
  max-width: 95vw;
  z-index: 2000;
  background: var(--card-bg);
  box-shadow: 0 6px 24px rgba(11, 37, 64, 0.15);
  border: 1px solid #e6eefc;
  border-radius: 12px;
  padding: 16px;
  opacity: 0;
  pointer-events: none;
  transition: right 0.35s cubic-bezier(.4,.0,.2,1), opacity 0.35s ease;
}

.calc-popup.open {
  right: 20px; /* slide into view */
  opacity: 1;
  pointer-events: auto;
}

/* Header */
.calc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--accent);
  font-weight: 600;
  margin-bottom: 8px;
}

/* Close button */
.calc-close-btn {
  background: transparent;
  color: var(--accent);
  border: none;
  font-size: 1rem;
  cursor: pointer;
  padding: 6px 8px;
  border-radius: 6px;
  transition: background 0.2s;
}
.calc-close-btn:hover {
  background: rgba(11, 95, 255, 0.1);
}

/* Calculator container */
.calculator {
  width: 100%;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: var(--shadow);
  background: var(--card-bg);
  border: 1px solid #e6eefc;
}

/* Display */
.calculator-display {
  height: 90px;
  background: linear-gradient(to bottom, #f8fbff, #eef4ff);
  color: #0b2540;
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  justify-content: flex-end;
  padding: 12px;
  font-size: 1.8rem;
  border-bottom: 1px solid #dbeefe;
}
.previous-operand {
  font-size: 0.9rem;
  color: var(--muted);
  height: 18px;
}

/* Buttons grid */
.calculator-buttons {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  background: #fbfdff;
  padding: 10px;
}

.calculator-button {
  padding: 14px 0;
  font-size: 1.1rem;
  border: none;
  outline: none;
  background: #eef4ff;
  color: #0b2540;
  cursor: pointer;
  transition: all 0.15s ease;
  border-radius: 6px;
  font-weight: 500;
  box-shadow: inset 0 1px 2px rgba(0,0,0,0.03);
}
.calculator-button:hover {
  background: #dbeefe;
  transform: translateY(-1px);
}

/* Special buttons */
.operator {
  background: var(--accent);
  color: #fff;
}
.operator:hover { background: #0056b3; }

.clear {
  background: #fef2f2;
  color: var(--danger);
  font-weight: bold;
}
.clear:hover { background: #fee2e2; }

.equals {
  background: var(--success);
  color: #fff;
  font-weight: bold;
}
.equals:hover { background: #047857; }

.calc-footer {
  margin-top: 10px;
  text-align: center;
  color: var(--muted);
  font-size: 12px;
}

</style>
</head>
<body>
  {% extends "base.html" %}
  {% block title %}Exam · CBT{% endblock %}
  {% block content %}
  <div class="header">
    <div>
      <a href="/"><strong>CBT</strong></a>
      <a href="/student">Student</a>
      <a href="/teacher">Teacher</a>
      <a href="/admin">Admin</a>
    </div>
    <div class="small">Exam: {{ title|escape }}</div>
  </div>

  <div class="container">
    <div class="card">
      <div id="errorNotice" class="error-notice small" style="display:none"></div>
      <div class="row" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
        <div>
          <div class="timer">Time remaining: <span id="timer">--:--</span> <span id="draftStatus" class="draft"></span></div>
          <div class="progress-bar">
            <div id="progressFill"></div>
          </div>
          <div class="small" id="serverNotice"></div>
        </div>
        <div>
          <button id="reviewBtn">Review Unanswered</button>
          <button id="submitBtn">Submit Answers</button>
          <button id="calcToggleBtn" class="nav-btn" type="button">Calculator</button>
        </div>
      </div>

      <div id="questionCounter" class="question-counter"></div>
      <div id="questions" style="margin-top:16px"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:20px">
        <button id="prevBtn" class="btn" style="min-width:100px">Previous</button>
        <button id="nextBtn" class="btn" style="min-width:100px">Next</button>
      </div>
      <div id="unansweredList" style="display:none"></div>
    </div>
  </div>

  <!-- Calculator popup -->
  <div id="calcPopup" class="calc-popup" aria-hidden="true" role="dialog" aria-labelledby="calcTitle">
    <div class="calc-header">
      <div id="calcTitle"></div>
        <button id="calcCloseBtn" class="calc-close-btn" title="Close">⤫</button>
      <div class="calc-popup"></div>
    <div class="calc-container">
    <div class="calc-header">
        <!-- <div>
          <button id="calcPinBtn" class="calc-close-btn" title="Close (toggle)">⤫</button>
        </div> -->
      </div>

      <div class="calc-container">
        <div class="calculator" id="embeddedCalculator" aria-hidden="false">
          <div class="calculator-display">
              <div class="previous-operand" id="calc-previous-operand"></div>
              <div id="calc-display">0</div>
          </div>
          <div class="calculator-buttons">
                  <button class="calculator-button clear" data-action="clear">AC</button>
                  <button class="calculator-button operator" data-action="op" data-val="/">/</button>
                  <button class="calculator-button operator" data-action="op" data-val="*">×</button>
                  <button class="calculator-button operator" data-action="del">⌫</button>
                  <button class="calculator-button" data-action="num" data-val="7">7</button>
                  <button class="calculator-button" data-action="num" data-val="8">8</button>
                  <button class="calculator-button" data-action="num" data-val="9">9</button>
                  <button class="calculator-button operator" data-action="op" data-val="-">-</button>
                  <button class="calculator-button" data-action="num" data-val="4">4</button>
                  <button class="calculator-button" data-action="num" data-val="5">5</button>
                  <button class="calculator-button" data-action="num" data-val="6">6</button>
                  <button class="calculator-button operator" data-action="op" data-val="+">+</button>
                  <button class="calculator-button" data-action="num" data-val="1">1</button>
                  <button class="calculator-button" data-action="num" data-val="2">2</button>
                  <button class="calculator-button" data-action="num" data-val="3">3</button>
                  <button class="calculator-button equals" data-action="eval">=</button>
                  <button class="calculator-button" data-action="num" data-val="0" style="grid-column:span 2">0</button>
                  <button class="calculator-button" data-action="num" data-val=".">.</button>
          </div>
        </div>
      </div>
      <div class="calc-footer">Calculator idea by Nathaniel, built by CHRISTTech</div>
    </div>
  </div>

  <!-- Store JSON data in a script tag to avoid inline syntax errors -->
  <script id="questions-data" type="application/json">{{ questions|tojson|safe }}</script>
  <script id="remaining-data" type="application/json">{{ remaining_seconds|tojson|safe }}</script>
  <script id="token-data" type="application/json">{{ token|escape|tojson|safe }}</script>

<script>
let questions = [];
try {
  const questionsData = document.getElementById('questions-data').textContent;
  questions = JSON.parse(questionsData);
  if (!Array.isArray(questions) || questions.length === 0) {
    throw new Error('Invalid or empty questions data');
  }
} catch (e) {
  console.error('Error parsing questions:', e, 'Raw data:', document.getElementById('questions-data').textContent);
  document.getElementById('errorNotice').style.display = 'block';
  document.getElementById('errorNotice').innerText = 'Error loading exam questions. Please try again or contact support.';
  document.getElementById('questions').style.display = 'none';
  document.getElementById('submitBtn').disabled = true;
  document.getElementById('reviewBtn').disabled = true;
  document.getElementById('prevBtn').disabled = true;
  document.getElementById('nextBtn').disabled = true;
}

let token = '';
try {
  token = JSON.parse(document.getElementById('token-data').textContent);
} catch (e) {
  console.error('Error parsing token:', e);
}

let remaining = 0;
try {
  remaining = Number(JSON.parse(document.getElementById('remaining-data').textContent));
  if (isNaN(remaining) || remaining < 0) {
    throw new Error('Invalid remaining_seconds');
  }
} catch (e) {
  console.error('Error parsing remaining_seconds:', e, 'Raw data:', document.getElementById('remaining-data').textContent);
  remaining = 0;
  document.getElementById('errorNotice').style.display = 'block';
  document.getElementById('errorNotice').innerText += ' Error loading exam timer. Exam may have expired.';
  document.getElementById('submitBtn').disabled = true;
}

const timerEl = document.getElementById('timer');
const qContainer = document.getElementById('questions');
const submitBtn = document.getElementById('submitBtn');
const draftStatus = document.getElementById('draftStatus');
const serverNotice = document.getElementById('serverNotice');
const progressFill = document.getElementById('progressFill');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const reviewBtn = document.getElementById('reviewBtn');
const questionCounter = document.getElementById('questionCounter');
const unansweredList = document.getElementById('unansweredList');

let answers = {}; // qid -> letter (A, B, C, ...)
let currentQuestionIndex = 0; // Track current question
const DRAFT_KEY = 'cbt:answers:' + token;
let draftSavedTimer = null;

// Restore draft (normalize to LETTER values)
try {
  const s = localStorage.getItem(DRAFT_KEY);
  if (s) {
    const parsed = JSON.parse(s) || {};
    for (const k of Object.keys(parsed)) {
      const v = parsed[k];
      if (v === null || v === '') { delete parsed[k]; continue; }
      if (typeof v === 'number' || /^\d+$/.test(String(v))) {
        const idx = Number(v);
        parsed[k] = String.fromCharCode(65 + idx);
      } else if (typeof v === 'string') {
        const s0 = String(v).trim();
        if (/^[A-Za-z]$/.test(s0)) parsed[k] = s0.toUpperCase();
        else if (/^\d+$/.test(s0)) parsed[k] = String.fromCharCode(65 + Number(s0));
        else parsed[k] = s0.toUpperCase();
      } else {
        delete parsed[k];
      }
    }
    answers = parsed;
  }
} catch (e) {
  console.error('Error restoring draft:', e);
}

// Render current question
function escapeHtml(s) {
  return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'" :'&#39;'}[m]));
}

function render() {
  qContainer.innerHTML = '';
  unansweredList.style.display = 'none';
  const q = questions[currentQuestionIndex];
  if (!q) return;

  questionCounter.innerText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;

  const div = document.createElement('div');
  div.className = 'question';
  let html = `<div><strong>Q${currentQuestionIndex + 1}.</strong> ${escapeHtml(q.question)}</div>`;
  html += '<div style="margin-top:12px">';
  (q.choices || []).forEach((ch, i) => {
    const id = `q_${q.id}_${i}`;
    const letter = String.fromCharCode(65 + i); // A, B, C, ...
    html += `<label class="label"><input type="radio" name="r_${q.id}" value="${letter}" id="${id}"> ${letter}. ${escapeHtml(ch)}</label>`;
  });
  html += '</div>';
  div.innerHTML = html;
  qContainer.appendChild(div);

  // Update navigation buttons
  prevBtn.disabled = currentQuestionIndex === 0;
  nextBtn.disabled = currentQuestionIndex === questions.length - 1;

  // Add radio listeners
  const radios = div.querySelectorAll('input[type="radio"]');
  radios.forEach(r => {
    r.addEventListener('change', (ev) => {
      // store letter (A/B/...)
      answers[q.id] = String(ev.target.value).toUpperCase();
      scheduleDraftSave();
      updateProgress();
    });
  });

  // Restore saved choice
  if (answers[q.id] !== undefined) {
    const sel = div.querySelector(`input[value="${answers[q.id]}"]`);
    if (sel) sel.checked = true;
  }
}
if (questions.length > 0) render();

// Navigation
prevBtn.addEventListener('click', () => {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    render();
  }
});
nextBtn.addEventListener('click', () => {
  if (currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    render();
  }
});

// Keyboard navigation
document.addEventListener('keydown', (ev) => {
  if (ev.key === 'ArrowLeft' && currentQuestionIndex > 0) {
    currentQuestionIndex--;
    render();
  } else if (ev.key === 'ArrowRight' && currentQuestionIndex < questions.length - 1) {
    currentQuestionIndex++;
    render();
  }
});

// Review unanswered questions
reviewBtn.addEventListener('click', () => {
  const unanswered = questions.filter(q => answers[q.id] === undefined);
  if (unanswered.length === 0) {
    unansweredList.style.display = 'block';
    unansweredList.innerHTML = '<div class="small success">All questions answered!</div>';
    return;
  }
  unansweredList.style.display = 'block';
  unansweredList.innerHTML = '<div class="small">Unanswered questions (click to jump):</div>';
  unanswered.forEach((q, idx) => {
    const qIndex = questions.findIndex(que => que.id === q.id);
    const div = document.createElement('div');
    div.innerText = `Q${qIndex + 1}: ${q.question.substring(0, 50)}...`;
    div.addEventListener('click', () => {
      currentQuestionIndex = qIndex;
      render();
    });
    unansweredList.appendChild(div);
  });
});

// Save draft to localStorage
function saveDraft() {
  try {
    localStorage.setItem(DRAFT_KEY, JSON.stringify(answers || {}));
    draftStatus.innerText = 'Saved';
    draftStatus.style.color = 'var(--success)';
  } catch (e) {
    console.error('Failed to save draft', e);
    draftStatus.innerText = 'Save failed';
    draftStatus.style.color = 'var(--danger)';
  }
  if (draftSavedTimer) { clearTimeout(draftSavedTimer); draftSavedTimer = null; }
}

function scheduleDraftSave() {
  draftStatus.innerText = 'Saving...';
  draftStatus.style.color = 'var(--muted)';
  if (draftSavedTimer) clearTimeout(draftSavedTimer);
  draftSavedTimer = setTimeout(saveDraft, 700);
}

function updateProgress() {
  const total = questions.length || 1;
  const answered = Object.keys(answers).length;
  const pct = Math.round((answered / total) * 100);
  progressFill.style.width = pct + '%';
}
if (questions.length > 0) updateProgress();

// check for unanswered questions; returns true if user confirmed or all answered
function checkUnanswered() {
  const unanswered = questions.filter(q => !answers.hasOwnProperty(q.id));
  if (unanswered.length === 0) return true;
  const msg = `You have ${unanswered.length} unanswered question(s). Continue submission?`;
  return confirm(msg);
}

// Beforeunload guard
function beforeUnloadHandler(e) {
  try {
    const s = localStorage.getItem(DRAFT_KEY);
    if (s && Object.keys(JSON.parse(s) || {}).length > 0) {
      e.preventDefault();
      e.returnValue = 'You have answers saved locally. Leaving will discard them.';
      return e.returnValue;
    }
  } catch (e) {}
}
window.addEventListener('beforeunload', beforeUnloadHandler);

// Timer and auto-submit
function updateTimer() {
  const mins = Math.floor(remaining / 60);
  const secs = remaining % 60;
  timerEl.innerText = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  if (remaining <= 0) {
    lockUI();
    autoSubmit();
    clearInterval(timerInterval);
  }
  remaining = Math.max(0, remaining - 1);
}

//Start countdown timer
const timerInterval = setInterval(updateTimer, 1000);
updateTimer();

function lockUI() {
  document.querySelectorAll('input, button').forEach(el => el.classList.add('disabled'));
  submitBtn.disabled = true;
}

async function autoSubmit() {
  if (!checkUnanswered()) {
    alert('You have unanswered questions, but time is up. Submitting now.');
  }
  try {
    const payload = { answers };
    const storedName = localStorage.getItem('cbt:student_name');
    if (storedName) payload.name = storedName;
    await fetch('/api/submit/' + token, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
  } catch (e) {
    console.error('Auto-submit failed:', e);
  }
  window.removeEventListener('beforeunload', beforeUnloadHandler);
  window.location.href = '/results/' + token;
}

submitBtn.addEventListener('click', async () => {
  if (!checkUnanswered()) {
    const confirmed = confirm('You have unanswered questions. Do you really want to submit?');
    if (!confirmed) return;
  }
  lockUI();
  draftStatus.innerText = 'Submitting...';
  try {
    const payload = { answers };
    const storedName = localStorage.getItem('cbt:student_name');
    if (storedName) payload.name = storedName;
    await fetch('/api/submit/' + token, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    window.location.href = '/results/' + token;
  } catch (e) {
    console.error('Submit failed:', e);
    lockUI();
    draftStatus.innerText = 'Submit failed. Please try again.';
    draftStatus.style.color = 'var(--danger)';
  }
});

// Calculator toggle + logic (scoped to avoid collisions)
(function(){
  const popup = document.getElementById('calcPopup');
  const toggleBtn = document.getElementById('calcToggleBtn');
  const closeBtn = document.getElementById('calcCloseBtn');
  const display = popup.querySelector('#calc-display');
  const prevDisplay = popup.querySelector('#calc-previous-operand');
  const buttons = popup.querySelectorAll('.calculator-button');

  let calcState = {
    current: '0',
    previous: '',
    operation: null,
    shouldReset: false
  };

  function formatDisplay(v){ return String(v); }

  function resetCalcScreen(){
    calcState.current = '';
    calcState.shouldReset = false;
  }

  function appendCalcNumber(n){
    if (calcState.current === '0' || calcState.shouldReset) resetCalcScreen();
    if (n === '.' && calcState.current.includes('.')) return;
    calcState.current = (calcState.current || '') + n;
    updateCalcUI();
  }

  function chooseCalcOp(op){
    if (calcState.current === '') return;
    if (calcState.previous !== ''){
      computeCalc();
    }
    calcState.operation = op;
    calcState.previous = calcState.current;
    calcState.current = '';
    updateCalcUI();
  }

  function computeCalc(){
    const prev = parseFloat(calcState.previous);
    const curr = parseFloat(calcState.current);
    if (isNaN(prev) || isNaN(curr)) return;
    let out;
    switch(calcState.operation){
      case '+': out = prev + curr; break;
      case '-': out = prev - curr; break;
      case '*': out = prev * curr; break;
      case '/': out = curr === 0 ? '∞' : (prev / curr); break;
      default: return;
    }
    calcState.current = String(out);
    calcState.operation = null;
    calcState.previous = '';
    calcState.shouldReset = true;
    updateCalcUI();
  }

  function clearCalc(){
    calcState.current = '0'; calcState.previous=''; calcState.operation=null; calcState.shouldReset=false;
    updateCalcUI();
  }

  function delCalc(){
    if (calcState.shouldReset){ calcState.current='0'; calcState.shouldReset=false; updateCalcUI(); return; }
    if (!calcState.current || calcState.current.length <= 1) calcState.current='0';
    else calcState.current = calcState.current.slice(0,-1);
    updateCalcUI();
  }

  function updateCalcUI(){
    display.textContent = formatDisplay(calcState.current || '0');
    prevDisplay.textContent = (calcState.previous ? (calcState.previous + (calcState.operation ? (' ' + calcState.operation) : '')) : '');
  }

  // attach button handlers
  buttons.forEach(btn=>{
    const action = btn.dataset.action;
    const val = btn.dataset.val;
    btn.addEventListener('click', (e)=>{
      if (action === 'num') appendCalcNumber(val);
      else if (action === 'op') chooseCalcOp(val);
      else if (action === 'eval') computeCalc();
      else if (action === 'clear') clearCalc();
      else if (action === 'del') delCalc();
    });
  });

  // Toggle overlay
function toggleCalc() {
  const open = popup.classList.toggle('open');
  popup.setAttribute('aria-hidden', String(!open));
  if (open) {
      setTimeout(() => popup.querySelector('[data-action="num"]')?.focus(), 150);
    }
  }
  toggleBtn.addEventListener('click', toggleCalc);
  closeBtn.addEventListener('click', toggleCalc);


  // allow keyboard interaction when calculator open (digits + ops + Enter/Esc)
  document.addEventListener('keydown', (ev)=>{
    if (!overlay.classList.contains('open')) return;
    if (/^[0-9]$/.test(ev.key)) { appendCalcNumber(ev.key); ev.preventDefault(); }
    if (ev.key === '.') { appendCalcNumber('.'); ev.preventDefault(); }
    if (['+','-','*','/'].includes(ev.key)) { chooseCalcOp(ev.key); ev.preventDefault(); }
    if (ev.key === 'Enter') { computeCalc(); ev.preventDefault(); }
    if (ev.key === 'Backspace') { delCalc(); ev.preventDefault(); }
    if (ev.key === 'Escape') { toggleCalc(); ev.preventDefault(); }
  });

  // initialize UI
  updateCalcUI();
})();
</script>

</body>
</html>
{% endblock %}